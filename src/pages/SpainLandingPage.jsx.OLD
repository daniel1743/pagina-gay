import React, { useState, useEffect } from 'react';
import { useNavigate, useLocation } from 'react-router-dom';
import { motion, AnimatePresence } from 'framer-motion';
import { MessageSquare, Users, Heart, Star, ArrowRight, Zap, Shield, Clock, Sparkles } from 'lucide-react';
import { Button } from '@/components/ui/button';
import { useAuth } from '@/contexts/AuthContext';
import { useCanonical } from '@/hooks/useCanonical';
import ChatDemo from '@/components/landing/ChatDemo';
import { GuestUsernameModal } from '@/components/auth/GuestUsernameModal';
import { EntryOptionsModal } from '@/components/auth/EntryOptionsModal';

const SpainLandingPage = () => {
  console.log('ðŸ”¥ [PASO 1/10] Componente SpainLandingPage iniciado');

  const navigate = useNavigate();
  const location = useLocation();
  const { user } = useAuth();
  const [showGuestModal, setShowGuestModal] = React.useState(false);
  const [showEntryModal, setShowEntryModal] = React.useState(false);

  // ðŸ”¥ Carrusel de imÃ¡genes - 5 modelos que cambian cada 3 segundos
  const [currentImageIndex, setCurrentImageIndex] = useState(0);
  const [imageLoadStatus, setImageLoadStatus] = useState({});
  const heroRef = React.useRef(null);

  const modelImages = [
    '/MODELO 1.jpeg',
    '/MODELO 2.jpeg',
    '/MODELO 3.jpeg',
    '/MODELO 4.jpeg',
    '/MODELO 5.jpeg'
  ];

  console.log('ðŸ”¥ [PASO 2/10] Variables de estado inicializadas', {
    currentImageIndex,
    totalImages: modelImages.length,
    user: user ? 'logged' : 'guest'
  });

  // Cambiar imagen cada 3 segundos
  useEffect(() => {
    console.log('ðŸ”¥ [PASO 3/10] Iniciando carrusel de imÃ¡genes');
    const interval = setInterval(() => {
      setCurrentImageIndex((prevIndex) => {
        const newIndex = (prevIndex + 1) % modelImages.length;
        console.log(`ðŸ“¸ Cambiando imagen: ${prevIndex} â†’ ${newIndex}`);
        return newIndex;
      });
    }, 3000);

    return () => {
      console.log('ðŸ§¹ Limpiando intervalo de carrusel');
      clearInterval(interval);
    };
  }, [modelImages.length]);

  // ðŸ” DETECTOR DE PANTALLA OSCURA
  useEffect(() => {
    console.log('ðŸ”¥ [PASO 4/10] Detector de pantalla oscura activado');

    const checkScreenBrightness = () => {
      if (!heroRef.current) {
        console.warn('âš ï¸ heroRef no disponible aÃºn');
        return;
      }

      const heroElement = heroRef.current;
      const computedStyle = window.getComputedStyle(heroElement);
      const backgroundColor = computedStyle.backgroundColor;
      const backgroundImage = computedStyle.backgroundImage;
      const marginTop = computedStyle.marginTop;
      const zIndex = computedStyle.zIndex;
      const height = heroElement.offsetHeight;
      const width = heroElement.offsetWidth;

      console.log('ðŸ“Š [DIAGNÃ“STICO VISUAL]', {
        backgroundColor,
        backgroundImage,
        marginTop,
        zIndex,
        height,
        width,
        positionTop: heroElement.getBoundingClientRect().top,
        visible: height > 0 && width > 0
      });

      // Detectar si se ve oscuro
      const isDark = backgroundColor.includes('rgb(0, 0, 0)') ||
                     backgroundColor.includes('rgba(0, 0, 0') ||
                     height === 0 ||
                     width === 0;

      if (isDark) {
        console.error('âŒ Â¡PANTALLA OSCURA DETECTADA!', {
          razon: height === 0 ? 'Altura 0' : width === 0 ? 'Ancho 0' : 'Fondo negro',
          backgroundColor,
          height,
          width
        });
      } else {
        console.log('âœ… Pantalla con contenido visible', {
          backgroundColor,
          height,
          width
        });
      }
    };

    // Verificar mÃºltiples veces
    const timeouts = [
      setTimeout(checkScreenBrightness, 100),
      setTimeout(checkScreenBrightness, 500),
      setTimeout(checkScreenBrightness, 1000),
      setTimeout(checkScreenBrightness, 2000)
    ];

    return () => timeouts.forEach(clearTimeout);
  }, []);

  // ðŸ–¼ï¸ DETECTOR DE CARGA DE IMÃGENES
  useEffect(() => {
    console.log('ðŸ”¥ [PASO 5/10] Iniciando precarga de imÃ¡genes');

    modelImages.forEach((src, index) => {
      const img = new Image();
      img.onload = () => {
        console.log(`âœ… Imagen ${index + 1} cargada exitosamente:`, src);
        setImageLoadStatus(prev => ({ ...prev, [src]: 'loaded' }));
      };
      img.onerror = (e) => {
        console.error(`âŒ Error cargando imagen ${index + 1}:`, src, e);
        setImageLoadStatus(prev => ({ ...prev, [src]: 'error' }));
      };
      img.src = src;
    });
  }, []);

  // âœ… SEO: Canonical tag dinÃ¡mico
  useCanonical('/es');

  React.useEffect(() => {
    console.log('ðŸ”¥ [PASO 6/10] Aplicando SEO tags...');

    // âœ… SEO: Title y meta description optimizados para EspaÃ±a
    const previousTitle = document.title;

    const metaDescription = document.querySelector('meta[name="description"]');
    const hadMetaDescription = !!metaDescription;
    const previousDescription = metaDescription?.getAttribute('content') ?? '';

    document.title = 'Chat Gay EspaÃ±a ðŸ³ï¸â€ðŸŒˆ Gratis - Madrid, Barcelona, Chueca | Chactivo';

    let ensuredMeta = metaDescription;
    if (!ensuredMeta) {
      ensuredMeta = document.createElement('meta');
      ensuredMeta.name = 'description';
      document.head.appendChild(ensuredMeta);
    }

    ensuredMeta.content = 'Chat gay EspaÃ±a 100% gratis. Conoce tÃ­os de Madrid, Barcelona, Chueca y toda EspaÃ±a. Sin rollos, sin registro. Entra ya y chatea con gays espaÃ±oles.';

    // Keywords especÃ­ficos de EspaÃ±a
    let keywords = document.querySelector('meta[name="keywords"]');
    const hadKeywords = !!keywords;
    const previousKeywords = keywords?.getAttribute('content') ?? '';
    if (!keywords) {
      keywords = document.createElement('meta');
      keywords.setAttribute('name', 'keywords');
      document.head.appendChild(keywords);
    }
    keywords.setAttribute('content', 'chat gay espaÃ±a, chat gay madrid, chat gay barcelona, chueca madrid, gay espaÃ±a online, ligar gay espaÃ±a, conocer gays espaÃ±a, chat homosexual espaÃ±a, salas gay madrid, chat lgbt espaÃ±a');

    return () => {
      // Restore title
      document.title = previousTitle;

      // Restore or remove meta description
      const currentMeta = document.querySelector('meta[name="description"]');
      if (!currentMeta) return;

      if (hadMetaDescription) {
        currentMeta.setAttribute('content', previousDescription);
      } else {
        currentMeta.remove();
      }

      // Restore keywords
      const currentKeywords = document.querySelector('meta[name="keywords"]');
      if (currentKeywords) {
        if (hadKeywords) {
          currentKeywords.setAttribute('content', previousKeywords);
        } else {
          currentKeywords.remove();
        }
      }
    };
  }, []);

  const handleChatearAhora = () => {
    if (user && !user.isGuest) {
      navigate('/chat/es-main');
    } else {
      setShowEntryModal(true);
    }
  };

  const handleContinueWithoutRegister = () => {
    setShowEntryModal(false);
    setShowGuestModal(true);
  };

  const handleEnterChat = () => {
    if (user && !user.isGuest) {
      navigate('/chat/es-main');
    } else {
      setShowGuestModal(true);
    }
  };

  console.log('ðŸ”¥ [PASO 7/10] Preparando renderizado JSX...');
  console.log('ðŸ“Š Estado actual:', {
    currentImageIndex,
    modelImages: modelImages.length,
    imageLoadStatus,
    user: user ? 'exists' : 'null',
    location: location.pathname
  });

  console.log('ðŸ”¥ [PASO 8/10] Iniciando renderizado JSX');

  return (
    <div className="min-h-screen">
      {/* ðŸŽ¯ HERO MOBILE-FIRST - Full screen en mobile para visibilidad inmediata */}
      <motion.div
        ref={heroRef}
        initial={{ opacity: 0 }}
        animate={{ opacity: 1 }}
        transition={{ duration: 0.6 }}
        className="w-full relative overflow-hidden"
        style={{
          marginTop: '-4rem',
          zIndex: 1
        }}
        onAnimationComplete={() => {
          console.log('ðŸ”¥ [PASO 9/10] AnimaciÃ³n de entrada completada');
        }}
      >
        <div className="w-full h-[60vh] md:h-[75vh] relative group">
          {/* Carrusel de imÃ¡genes */}
          <AnimatePresence mode="wait">
            <motion.div
              key={currentImageIndex}
              initial={{ opacity: 0 }}
              animate={{ opacity: 1 }}
              exit={{ opacity: 0 }}
              transition={{ duration: 0.6, ease: 'easeInOut' }}
              className="absolute inset-0 w-full h-full"
            >
              <div className="w-full h-full relative overflow-hidden">
                <img
                  src={encodeURI(modelImages[currentImageIndex])}
                  alt="Chat gay EspaÃ±a - Madrid Barcelona Chueca"
                  className="absolute inset-0 w-full h-full object-cover object-center"
                  loading={currentImageIndex === 0 ? 'eager' : 'lazy'}
                  onLoad={(e) => {
                    console.log('ðŸ”¥ [PASO 10/10] âœ… Imagen renderizada en pantalla:', {
                      src: modelImages[currentImageIndex],
                      width: e.target.naturalWidth,
                      height: e.target.naturalHeight,
                      displayed: e.target.complete,
                      visible: e.target.offsetWidth > 0 && e.target.offsetHeight > 0
                    });
                  }}
                  onError={(e) => {
                    console.error('âŒ Error cargando imagen:', {
                      src: modelImages[currentImageIndex],
                      encodedSrc: encodeURI(modelImages[currentImageIndex]),
                      error: e.type
                    });
                    const altPath = modelImages[currentImageIndex].replace(' ', '%20');
                    if (e.target.src !== altPath) {
                      console.log('ðŸ”„ Intentando con ruta alternativa:', altPath);
                      e.target.src = altPath;
                    } else {
                      console.error('âŒ Todas las rutas fallaron, ocultando imagen');
                      e.target.style.display = 'none';
                    }
                  }}
                />

                {/* Overlay optimizado para legibilidad sin oscurecer demasiado */}
                <div className="absolute inset-0 bg-gradient-to-b from-black/50 via-black/40 to-black/60"></div>
                <div className="absolute inset-0 bg-gradient-to-t from-black/60 via-transparent to-transparent"></div>
              </div>
            </motion.div>
          </AnimatePresence>

          {/* Contenido sobre la imagen */}
          <div className="absolute inset-0 z-10 h-full flex items-center justify-center px-4 sm:px-6">
            <div className="text-center max-w-3xl w-full">
              {/* H1 Principal - SEO optimizado para EspaÃ±a */}
              <motion.h1
                initial={{ opacity: 0, y: 20 }}
                animate={{ opacity: 1, y: 0 }}
                transition={{ duration: 0.6 }}
                className="text-2xl sm:text-3xl md:text-4xl lg:text-5xl font-black mb-3 sm:mb-4 drop-shadow-2xl leading-tight px-2"
              >
                <span className="bg-gradient-to-r from-purple-400 via-purple-500 to-cyan-400 bg-clip-text text-transparent">
                  Chat Gay EspaÃ±a: Conoce TÃ­os de Madrid, Barcelona y Chueca
                </span>
              </motion.h1>

              {/* H2 - Tono espaÃ±ol directo */}
              <motion.h2
                initial={{ opacity: 0, y: 10 }}
                animate={{ opacity: 1, y: 0 }}
                transition={{ duration: 0.6, delay: 0.1 }}
                className="text-base sm:text-lg md:text-xl text-white/95 font-semibold drop-shadow-lg mb-5 sm:mb-6 leading-relaxed px-2"
              >
                Sin rollos, tÃ­o. Gente real de EspaÃ±a conversando ahora.
              </motion.h2>

              {/* CTA - Directo y urgente */}
              <motion.div
                initial={{ opacity: 0, scale: 0.95 }}
                animate={{ opacity: 1, scale: 1 }}
                transition={{ duration: 0.5, delay: 0.2 }}
              >
                <Button
                  onClick={handleChatearAhora}
                  className="bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-500 hover:to-pink-500 text-white font-black px-6 sm:px-10 py-3 sm:py-4 text-base sm:text-lg rounded-xl shadow-2xl hover:shadow-purple-500/50 transition-all hover:scale-105 w-full sm:w-auto uppercase tracking-wide"
                  style={{ minHeight: '48px' }}
                >
                  Â¡ENTRAR AL CHAT YA!
                </Button>
              </motion.div>

              {/* Microcopy */}
              <motion.p
                initial={{ opacity: 0 }}
                animate={{ opacity: 1 }}
                transition={{ duration: 0.5, delay: 0.3 }}
                className="text-sm sm:text-base text-white/80 mt-4 sm:mt-5 font-medium"
              >
                Sin email â€¢ Sin tarjeta â€¢ Sin complicaciones
              </motion.p>
            </div>
          </div>

          {/* Indicadores de imÃ¡genes */}
          <div className="absolute bottom-2 left-1/2 transform -translate-x-1/2 z-20 flex gap-0.5">
            {modelImages.map((_, index) => (
              <button
                key={index}
                onClick={() => setCurrentImageIndex(index)}
                className={`transition-all duration-300 rounded-full ${
                  index === currentImageIndex
                    ? 'w-1 h-1 bg-white/50'
                    : 'w-0.5 h-0.5 bg-white/20 hover:bg-white/30'
                }`}
                aria-label={`Ir a imagen ${index + 1}`}
              />
            ))}
          </div>
        </div>
      </motion.div>

      {/* Contenido principal */}
      <div className="px-3 sm:px-4 py-4 sm:py-6">
        <div className="max-w-5xl mx-auto">

        {/* ðŸ”¥ CHAT DEMO */}
        <motion.section
          initial={{ opacity: 0, y: 20 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ duration: 0.5, delay: 0.2 }}
          className="mb-8 sm:mb-12"
        >
          <ChatDemo onJoinClick={handleChatearAhora} />
        </motion.section>

        {/* ðŸŽ¯ CTA INTERMEDIO */}
        <motion.div
          initial={{ opacity: 0, y: 20 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ delay: 0.3 }}
          className="text-center mt-6 sm:mt-8 mb-6"
        >
          <Button
            onClick={handleChatearAhora}
            className="bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-500 hover:to-pink-500 text-white font-black text-base sm:text-lg px-8 sm:px-12 py-4 sm:py-5 rounded-xl shadow-xl hover:shadow-purple-500/50 hover:scale-105 transition-all uppercase tracking-wide"
          >
            Â¡ENTRAR AL CHAT YA!
          </Button>
        </motion.div>

        {/* Benefits Section - Adaptado para EspaÃ±a */}
        <motion.section
          initial={{ opacity: 0, y: 20 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ delay: 0.3 }}
          className="mb-8 sm:mb-12"
        >
          <h2 className="text-xl sm:text-2xl font-bold text-center mb-6">
            Por quÃ© Chactivo EspaÃ±a
          </h2>
          <div className="grid grid-cols-1 md:grid-cols-3 gap-6 sm:gap-8">
            <div className="glass-effect rounded-2xl p-6 sm:p-8 border border-border">
              <div className="w-14 h-14 rounded-full bg-gradient-to-br from-cyan-500 to-blue-500 flex items-center justify-center mb-5">
                <Users className="w-7 h-7 text-white" />
              </div>
              <h3 className="text-xl font-bold mb-3">Comunidad Activa EspaÃ±a</h3>
              <p className="text-muted-foreground leading-relaxed">
                TÃ­os de Madrid, Barcelona, Valencia, Sevilla y toda EspaÃ±a. Siempre hay alguien online.
              </p>
            </div>

            <div className="glass-effect rounded-2xl p-6 sm:p-8 border border-border">
              <div className="w-14 h-14 rounded-full bg-gradient-to-br from-purple-500 to-pink-500 flex items-center justify-center mb-5">
                <MessageSquare className="w-7 h-7 text-white" />
              </div>
              <h3 className="text-xl font-bold mb-3">100% en EspaÃ±ol</h3>
              <p className="text-muted-foreground leading-relaxed">
                Conversa en espaÃ±ol con gente de tu zona. De Chueca al Eixample, todos conectados.
              </p>
            </div>

            <div className="glass-effect rounded-2xl p-6 sm:p-8 border border-border">
              <div className="w-14 h-14 rounded-full bg-gradient-to-br from-green-500 to-teal-500 flex items-center justify-center mb-5">
                <Heart className="w-7 h-7 text-white" />
              </div>
              <h3 className="text-xl font-bold mb-3">Ambiente Relajado</h3>
              <p className="text-muted-foreground leading-relaxed">
                Sin presiÃ³n. ConversaciÃ³n real, amistad genuina y respeto siempre.
              </p>
            </div>
          </div>
        </motion.section>

        {/* Final CTA */}
        <motion.section
          initial={{ opacity: 0, y: 30 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ delay: 0.7 }}
          className="text-center"
        >
          <div className="glass-effect rounded-3xl p-10 sm:p-16 border-2 border-cyan-500/30 bg-gradient-to-br from-cyan-900/20 to-blue-900/20">
            <h2 className="text-3xl sm:text-4xl font-extrabold mb-4">
              Â¿Listo para Conectar con Gays de Toda EspaÃ±a?
            </h2>
            <p className="text-lg text-muted-foreground mb-8 max-w-2xl mx-auto">
              Ãšnete al chat mÃ¡s activo de EspaÃ±a. ConversaciÃ³n real, ambiente relajado, 100% gratis.
            </p>
            <motion.div
              whileHover={{ scale: 1.05 }}
              whileTap={{ scale: 0.95 }}
            >
              <Button
                onClick={handleEnterChat}
                size="lg"
                className="bg-gradient-to-r from-cyan-600 to-blue-600 hover:from-cyan-500 hover:to-blue-500 text-white font-bold text-xl sm:text-2xl px-12 sm:px-20 py-6 sm:py-8 rounded-2xl shadow-2xl"
              >
                <MessageSquare className="w-7 h-7 mr-3" />
                Entrar al Chat Ahora
                <ArrowRight className="w-7 h-7 ml-3" />
              </Button>
            </motion.div>
            <p className="text-sm text-muted-foreground mt-6">
              ðŸ’¬ Chat EspaÃ±a â€¢ ðŸ”’ 100% anÃ³nimo â€¢ âš¡ Sin registro
            </p>
          </div>
        </motion.section>
        </div>
      </div>

      {/* ðŸ“± STICKY MOBILE CTA */}
      <motion.div
        initial={{ y: 100, opacity: 0 }}
        animate={{ y: 0, opacity: 1 }}
        transition={{ delay: 1.5, duration: 0.5 }}
        className="fixed bottom-0 left-0 right-0 z-40 p-4 bg-gradient-to-t from-background via-background to-transparent md:hidden"
      >
        <Button
          onClick={handleChatearAhora}
          className="w-full magenta-gradient text-white font-extrabold text-base sm:text-lg px-6 py-5 rounded-xl shadow-2xl hover:shadow-[#E4007C]/70 hover:scale-[1.02] transition-all animate-pulse-subtle"
        >
          âš¡ Chatear Gratis Ahora
        </Button>
      </motion.div>

      {/* Modals */}
      <EntryOptionsModal
        open={showEntryModal}
        onClose={() => setShowEntryModal(false)}
        chatRoomId="es-main"
        onContinueWithoutRegister={handleContinueWithoutRegister}
      />

      <GuestUsernameModal
        open={showGuestModal}
        onClose={() => setShowGuestModal(false)}
        chatRoomId="es-main"
      />
    </div>
  );
};

export default SpainLandingPage;
