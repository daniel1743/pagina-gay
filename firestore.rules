rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ===========================
    // FUNCIONES AUXILIARES
    // ===========================

    function isAuthenticated() {
      return request.auth != null;
    }

    // âœ… NUEVO: Verificar que el usuario NO sea anÃ³nimo (invitado)
    function isRegistered() {
      return isAuthenticated() && request.auth.token.firebase.sign_in_provider != 'anonymous';
    }

    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    function isPremium() {
      return isAuthenticated() &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isPremium == true;
    }

    // Admin por campo role en /users/{uid}
    function isAdmin() {
      return isAuthenticated() &&
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.keys().hasAny(['role']) &&
             (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin' || 
              get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'administrator');
    }

    // âœ… NUEVO: Admin o Support (para sistema de tickets)
    function isAdminOrSupport() {
      return isAuthenticated() &&
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.keys().hasAny(['role']) &&
             (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin' || 
              get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'administrator' ||
              get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'support');
    }

    // âœ… SUPER ADMIN: VerificaciÃ³n por email como capa extra de seguridad
    function isSuperAdmin() {
      return isAuthenticated() &&
             request.auth.token.email == 'caribenosvenezolanos@gmail.com';
    }

    // âœ… Admin verificado: Debe tener rol Y ser del email autorizado
    function isVerifiedAdmin() {
      return isSuperAdmin() || isAdmin();
    }

    // Provider anonymous
    function isAnonymous() {
      return isAuthenticated() && request.auth.token.firebase.sign_in_provider == 'anonymous';
    }

    // âœ… FIX: FunciÃ³n isNotBanned estaba faltante
    function isNotBanned() {
      // Verificar si el usuario tiene el campo banned en true
      return !exists(/databases/$(database)/documents/users/$(request.auth.uid)) ||
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.get('banned', false) == false;
    }

    // ===========================
    // FILTROS DE CONTENIDO
    // ===========================

    // âœ… PUBLICO: bloqueo fuerte (spam + insultos + drogas + contacto externo)
    function hasNoProhibitedWordsPublic(content) {
      let prohibitedPublic = [
        // spam/estafas/hack
        'spam', 'phishing', 'scam', 'hack', 'viagra',
        // insultos / ataques
        'puto', 'maricon', 'sidoso', 'enfermo', 'degenerado',
        // drogas / ilegal
        'drogas', 'coca', 'perico', 'sexopago', 'escort',
        // contacto externo / doxxing
        'whatsapp', 'instagram', 'telegram',
        'numero', 'nÃºmero', 'telefono', 'telÃ©fono',
        'llamame', 'llÃ¡mame', 'escribeme', 'escrÃ­beme',
        'dm', 'directo', 'mensaje privado',
        'correo', 'email', 'gmail',
        '@'
      ];
      return !content.matches('.*(' + prohibitedPublic.join('|') + ').*');
    }

    // âœ… PRIVADO: SOLO bloqueo insultos + spam/estafas/hack
    function hasNoProhibitedWordsPrivate(content) {
      let prohibitedPrivate = [
        // spam/estafas/hack
        'spam', 'phishing', 'scam', 'hack', 'viagra',
        // insultos / ataques
        'puto', 'maricon', 'sidoso', 'enfermo', 'degenerado'
      ];
      return !content.matches('.*(' + prohibitedPrivate.join('|') + ').*');
    }

    // ===========================
    // VALIDACIONES DE MENSAJES
    // ===========================

    function isValidMessage() {
      let data = request.resource.data;
      // âœ… Seguridad: userId SIEMPRE debe coincidir con el uid del auth
      // Campos mÃ­nimos Y validaciÃ³n de seguridad
      return isAuthenticated() &&
             'userId' in data &&
             data.userId == request.auth.uid &&
             'username' in data &&
             data.username is string &&
             'content' in data &&
             data.content is string &&
             data.content.size() > 0 &&
             data.content.size() <= 1000 &&
             'type' in data &&
             data.type in ['text', 'image', 'voice', 'system'] &&
             'timestamp' in data &&
             data.timestamp is timestamp;
    }

    // âœ… NUEVO: ValidaciÃ³n para usuarios NO autenticados (estrategia de captaciÃ³n)
    // Permitir chat en sala principal SIN autenticaciÃ³n para reducir fricciÃ³n
    function isValidUnauthenticatedMessage() {
      let data = request.resource.data;
      return !isAuthenticated() &&
             'userId' in data &&
             data.userId is string &&
             data.userId.matches('unauthenticated_.*') &&  // Solo IDs temporales
             'username' in data &&
             data.username is string &&
             data.username.size() >= 3 &&
             data.username.size() <= 30 &&
             'content' in data &&
             data.content is string &&
             data.content.size() > 0 &&
             data.content.size() <= 1000 &&  // Mismo lÃ­mite que usuarios autenticados
             'type' in data &&
             data.type == 'text' &&  // Solo texto (no imÃ¡genes ni voz)
             !data.content.matches('.*(https?://|www\\.).*') &&  // NO links externos
             hasNoProhibitedWordsPublic(data.content.lower());
    }

    // âœ… SISTEMA DE IA: permite mensajes AI con control del usuario autenticado
    // âœ… ACTUALIZADO: TambiÃ©n permite mensajes sembrados (seed_user_*)
    function isValidBotMessage() {
      let data = request.resource.data;
      return isAuthenticated() &&
             'senderUid' in data &&
             data.senderUid == request.auth.uid &&
             'userId' in data &&
             data.userId is string &&
             (data.userId.matches('bot_.*') || data.userId.matches('ai_.*') || data.userId.matches('seed_user_.*')) &&
             'username' in data &&
             data.username is string &&
             'content' in data &&
             data.content is string &&
             data.content.size() > 0 &&
             data.content.size() <= 1000 &&
             'type' in data &&
             data.type in ['text', 'image', 'voice', 'system'] &&
             'timestamp' in data &&
             data.timestamp is timestamp;
    }

    // âœ… NUEVO: Permite mensajes de sistema (moderador, VOC, etc.)
    function isValidSystemMessage() {
      let data = request.resource.data;
      return isAuthenticated() &&
             'userId' in data &&
             data.userId is string &&
             (data.userId == 'system' ||
              data.userId == 'system_moderator' ||
              data.userId == 'system_voc' ||
              data.userId.matches('system_.*')) &&
             'username' in data &&
             data.username is string &&
             'content' in data &&
             data.content is string &&
             data.content.size() > 0 &&
             data.content.size() <= 2000 &&
             'type' in data &&
             'timestamp' in data &&
             data.timestamp is timestamp;
    }

    function isAdult(age) {
      return age == null || (age is number && age >= 18);
    }

    // ===========================
    // REGLAS DE INVITADOS (ANÃ“NIMOS)
    // ===========================

    match /guests/{guestId} {
      allow read, write: if isAuthenticated() &&
                           request.auth.uid == guestId &&
                           request.auth.token.firebase.sign_in_provider == 'anonymous';
    }

    // ===========================
    // REGLAS DE USUARIOS
    // ===========================

    match /users/{userId} {
      // âœ… SUPER ADMIN puede leer cualquier usuario, otros solo si estÃ¡n autenticados
      allow read: if isSuperAdmin() || isAuthenticated();

      allow create: if isOwner(userId) &&
                      request.resource.data.username is string &&
                      request.resource.data.username.size() >= 3 &&
                      request.resource.data.username.size() <= 30 &&
                      request.resource.data.email is string &&
                      request.resource.data.isPremium == false &&
                      request.resource.data.verified == false &&
                      !request.resource.data.keys().hasAny(['role']) && // ðŸ”’ SEGURIDAD: Prevenir inyecciÃ³n de rol
                      isAdult(request.resource.data.get('age', null));

      allow update: if isOwner(userId) &&
                      request.resource.data.email == resource.data.email &&
                      request.resource.data.id == resource.data.id &&
                      request.resource.data.isPremium == resource.data.isPremium &&
                      request.resource.data.get('role', null) == resource.data.get('role', null); // ðŸ”’ SEGURIDAD: Prevenir modificaciÃ³n de rol

      allow delete: if isOwner(userId);

      // SubcolecciÃ³n de notificaciones del usuario
      match /notifications/{notificationId} {
        allow read: if isOwner(userId);

        // âœ… CRÃTICO: Cualquier usuario autenticado puede crear notificaciones (para mensajes directos y solicitudes de chat privado)
        // Admin/Support tambiÃ©n pueden crear notificaciones para usuarios (respuestas a tickets, etc.)
        allow create: if isAuthenticated();

        allow update: if isOwner(userId);

        allow delete: if isOwner(userId);
      }

      // âœ… SubcolecciÃ³n de mensajes enviados (historial)
      match /sent_messages/{messageId} {
        // Leer: solo el remitente puede ver sus mensajes enviados
        allow read: if isOwner(userId);

        // Crear: cualquier usuario autenticado puede crear (cuando envÃ­a un mensaje)
        allow create: if isAuthenticated();

        // No se pueden actualizar ni eliminar
        allow update, delete: if false;
      }
    }

    // ===========================
    // REGLAS DE PRESENCIA
    // ===========================

    match /roomPresence/{roomId}/users/{userId} {
      // Si quieres presencia pÃºblica total: cambia a `if true;`
      allow read: if isAuthenticated();

      // âœ… Permitir usuarios anÃ³nimos tambiÃ©n para presencia (necesario para el chat)
      allow create, update, delete: if isAuthenticated() &&
                                      request.auth.uid == userId;
    }

    // ===========================
    // REGLAS DE SALAS Y MENSAJES (PUBLICO)
    // ===========================

    // âœ… CRÃTICO: Permitir lectura de documentos de sala
    match /rooms/{roomId} {
      // Cualquiera puede leer informaciÃ³n de la sala (nombre, descripciÃ³n, etc.)
      allow read: if true;

      // Solo admins pueden crear/modificar salas
      allow write: if isAdmin();
    }

    match /rooms/{roomId}/messages/{messageId} {
      // âœ… CRÃTICO: Permitir lectura pÃºblica para SEO y UX
      // Cualquiera puede VER las conversaciones (incluso sin registro)
      // Esto permite que usuarios que lleguen desde Google puedan ver el chat
      allow read: if true;

      // ðŸ”¥ TEMPORAL: Reglas MUY PERMISIVAS para debugging
      // Permite CUALQUIER mensaje con content vÃ¡lido
      allow create: if
        request.resource.data.content is string &&
        request.resource.data.content.size() > 0 &&
        request.resource.data.content.size() <= 1000;

      // âœ… Permitir actualizar reacciones, deliveredTo, readBy, status (para sistema de checks)
      // âœ… Permitir actualizar reacciones, deliveredTo, readBy, status (para sistema de checks)
      allow update: if isAuthenticated() &&
                      request.resource.data.content == resource.data.content &&
                      request.resource.data.userId == resource.data.userId &&
                      request.resource.data.timestamp == resource.data.timestamp &&
                      (
                        // âœ… OpciÃ³n A: Usuarios REGISTRADOS (pueden reaccionar Y actualizar estado)
                        (isRegistered() && 
                         request.resource.data.diff(resource.data).affectedKeys()
                           .hasOnly(['reactions', 'deliveredTo', 'readBy', 'status', 'deliveredAt', 'readAt']))
                        ||
                        // âœ… OpciÃ³n B: Usuarios INVITADOS (SOLO pueden actualizar estado de entrega/lectura)
                        // NO pueden modificar 'reactions'
                        (!isRegistered() && 
                         request.resource.data.diff(resource.data).affectedKeys()
                           .hasOnly(['deliveredTo', 'readBy', 'status', 'deliveredAt', 'readAt']))
                      );

      allow delete: if isAuthenticated() &&
                      resource.data.userId == request.auth.uid;
    }

    // ===========================
    // REGLAS DE CHATS PRIVADOS
    // ===========================

    // âœ… RESTRICCIÃ“N: Chat privado SOLO para usuarios autenticados
    // Usuarios NO autenticados NO pueden crear ni acceder a chats privados
    // Esta restricciÃ³n es parte de la estrategia de captaciÃ³n (incentivo para registrarse)
    match /private_chats/{chatId} {
      // âŒ Usuarios NO autenticados NO pueden leer chats privados
      allow read: if isRegistered() &&
                    request.auth.uid in resource.data.participants;

      // âŒ Usuarios NO autenticados NO pueden crear chats privados
      allow create: if isRegistered() &&
                      request.resource.data.keys().hasAll(['participants', 'createdAt']) &&
                      request.auth.uid in request.resource.data.participants &&
                      request.resource.data.participants.size() == 2;

      match /messages/{messageId} {
        allow read: if isAuthenticated() &&
                      request.auth.uid in get(/databases/$(database)/documents/private_chats/$(chatId)).data.participants;

        // âœ… PRIVADO: se permite contacto/numero/redes, SOLO bloqueo insultos+spam
        // âœ… TambiÃ©n permite mensajes de sistema (type='system') sin validaciÃ³n estricta de userId
        allow create: if isAuthenticated() &&
                        request.auth.uid in get(/databases/$(database)/documents/private_chats/$(chatId)).data.participants &&
                        (
                          // Mensaje normal de usuario
                          (isValidMessage() && hasNoProhibitedWordsPrivate(request.resource.data.content.lower()))
                          ||
                          // Mensaje de sistema (notificaciÃ³n de salida)
                          (request.resource.data.type == 'system' &&
                           request.resource.data.userId == 'system' &&
                           'content' in request.resource.data &&
                           request.resource.data.content is string &&
                           request.resource.data.content.size() > 0)
                        );
      }
    }

    // ===========================
    // REPORTES/DENUNCIAS
    // ===========================

    match /reports/{reportId} {
      allow read: if isAdmin() ||
                    (isAuthenticated() && resource.data.reporterId == request.auth.uid);

      allow create: if isAuthenticated() &&
                      'reporterId' in request.resource.data &&
                      request.resource.data.reporterId == request.auth.uid &&
                      'type' in request.resource.data &&
                      'description' in request.resource.data &&
                      request.resource.data.description is string &&
                      request.resource.data.description.size() > 10 &&
                      'targetUsername' in request.resource.data &&
                      'status' in request.resource.data &&
                      request.resource.data.status in ['pending', 'open'];

      allow update: if isAdmin();

      allow delete: if false;
    }

    // ===========================
    // ANALYTICS
    // ===========================

    match /analytics_stats/{dateId} {
      // âœ… Permitir que usuarios autenticados escriban en analytics (para tracking de eventos)
      // Los usuarios solo pueden escribir en documentos que coincidan con su userId o fecha actual
      allow write: if isAuthenticated() && 
                      (isAdmin() || 
                       dateId == request.auth.uid || 
                       dateId.matches('\\d{4}-\\d{2}-\\d{2}'));
      allow read: if isAuthenticated();
    }

    // ===========================
    // CONEXIONES DE USUARIO
    // ===========================

    match /user_connections/{userId} {
      allow read: if isAuthenticated() && request.auth.uid == userId;

      allow create: if isAuthenticated() &&
                      request.auth.uid == userId &&
                      'userId' in request.resource.data &&
                      request.resource.data.userId == userId;

      allow update: if isAuthenticated() &&
                      request.auth.uid == userId &&
                      resource.data.userId == userId;

      allow delete: if false;
    }

    // ===========================
    // BLOQUEOS ENTRE USUARIOS
    // ===========================

    match /blocks/{userId} {
      // Leer lista propia
      allow read: if isAuthenticated() && request.auth.uid == userId;

      match /blockedUsers/{blockedUserId} {
        // Leer: dueÃ±o o el usuario bloqueado (para validar interacciÃ³n)
        allow read: if isAuthenticated() &&
                      (request.auth.uid == userId || request.auth.uid == blockedUserId);

        // Crear/Actualizar/Borrar: solo dueÃ±o del bloque
        allow create, update, delete: if isAuthenticated() &&
                                        request.auth.uid == userId;
      }
    }

    // ===========================
    // SANCIONES
    // ===========================

    match /sanctions/{sanctionId} {
      allow read: if isAdmin() ||
                    (isAuthenticated() &&
                     resource.data.userId == request.auth.uid &&
                     resource.data.status == 'active');

      allow create: if isAdmin() &&
                      'userId' in request.resource.data &&
                      'type' in request.resource.data &&
                      'reason' in request.resource.data &&
                      'issuedBy' in request.resource.data &&
                      request.resource.data.issuedBy == request.auth.uid &&
                      'status' in request.resource.data &&
                      request.resource.data.status == 'active';

      allow update: if isAdmin();

      allow delete: if false;
    }

    // ===========================
    // NOTIFICACIONES DEL SISTEMA
    // ===========================

    match /systemNotifications/{notificationId} {
      allow read: if isAuthenticated() &&
                    resource.data.userId == request.auth.uid;

      allow create: if isAdmin() &&
                      'userId' in request.resource.data &&
                      'title' in request.resource.data &&
                      'message' in request.resource.data &&
                      'type' in request.resource.data &&
                      'read' in request.resource.data &&
                      request.resource.data.read == false;

      allow update: if (isAuthenticated() &&
                       resource.data.userId == request.auth.uid &&
                       request.resource.data.userId == resource.data.userId &&
                       request.resource.data.title == resource.data.title &&
                       request.resource.data.message == resource.data.message &&
                       request.resource.data.diff(resource.data).affectedKeys().hasOnly(['read', 'readAt'])) ||
                      isAdmin();

      allow delete: if false;
    }

    // ===========================
    // TICKETS
    // ===========================

    match /tickets/{ticketId} {
      // âœ… CRÃTICO: Para queries a nivel de colecciÃ³n, admins necesitan acceso sin restricciÃ³n
      // Los usuarios normales solo pueden leer sus propios tickets (verificado en el documento)
      allow read: if isSuperAdmin() || 
                    isAdminOrSupport() ||
                    (isAuthenticated() && resource.data.userId == request.auth.uid) ||
                    (isAuthenticated() && resource.data.userUid == request.auth.uid);

      allow create: if isAuthenticated() &&
                      'userId' in request.resource.data &&
                      request.resource.data.userId == request.auth.uid &&
                      'subject' in request.resource.data &&
                      'description' in request.resource.data &&
                      'category' in request.resource.data &&
                      'priority' in request.resource.data &&
                      'status' in request.resource.data &&
                      request.resource.data.status == 'open';

      allow update: if isSuperAdmin() || isAdminOrSupport();

      allow delete: if false;

      // âœ… NUEVO: Mensajes del ticket (conversaciÃ³n)
      match /messages/{messageId} {
        // Leer: super admin, admin/support o dueÃ±o del ticket
        allow read: if isSuperAdmin() ||
                      isAdminOrSupport() ||
                      (isAuthenticated() &&
                       get(/databases/$(database)/documents/tickets/$(ticketId)).data.userId == request.auth.uid);

        // Crear: super admin o admin/support puede enviar mensajes
        allow create: if (isSuperAdmin() || isAdminOrSupport()) &&
                        'type' in request.resource.data &&
                        request.resource.data.type in ['external', 'internal'] &&
                        'author' in request.resource.data &&
                        'authorUid' in request.resource.data &&
                        'authorUsername' in request.resource.data &&
                        'body' in request.resource.data &&
                        request.resource.data.body is string &&
                        request.resource.data.body.size() > 0 &&
                        'createdAt' in request.resource.data;

        // No se permite editar o borrar mensajes
        allow update, delete: if false;
      }

      // âœ… NUEVO: Logs de auditorÃ­a del ticket
      match /logs/{logId} {
        // Leer: super admin o admin/support
        allow read: if isSuperAdmin() || isAdminOrSupport();

        // Crear: super admin o admin/support
        allow create: if (isSuperAdmin() || isAdminOrSupport()) &&
                        'action' in request.resource.data &&
                        'actorUid' in request.resource.data &&
                        'actorRole' in request.resource.data &&
                        'createdAt' in request.resource.data;

        // No se permite editar o borrar logs
        allow update, delete: if false;
      }
    }

    // ===========================
    // ÃNDICE DE USERNAMES
    // ===========================

    // âœ… NUEVO: Ãndice para validar disponibilidad de usernames
    match /usernames/{usernameLower} {
      // Leer: todos los autenticados (para validar disponibilidad)
      allow read: if isAuthenticated();

      // Crear/Actualizar/Borrar: solo admin (operaciones de cambio de username)
      allow create, update, delete: if isAdmin();
    }

    // ===========================
    // LOGS GLOBALES DE ADMIN
    // ===========================

    // âœ… NUEVO: Logs de todas las acciones administrativas
    match /admin_logs/{logId} {
      // Leer: solo admin
      allow read: if isAdmin();

      // Crear: solo admin
      allow create: if isAdmin() &&
                      'action' in request.resource.data &&
                      'adminUid' in request.resource.data &&
                      'adminUsername' in request.resource.data &&
                      'createdAt' in request.resource.data;

      // No se permite editar o borrar logs
      allow update, delete: if false;
    }

    // ===========================
    // FORO PUBLICO (MUY ESTRICTO)
    // ===========================

    match /forum_threads/{threadId} {
      allow read: if true;

      // âœ… foro pÃºblico: prohibido contacto + etc (filtro fuerte)
      allow create: if isAuthenticated() &&
                      !isAnonymous() &&
                      'title' in request.resource.data &&
                      request.resource.data.title is string &&
                      request.resource.data.title.size() > 0 &&
                      request.resource.data.title.size() <= 100 &&
                      'content' in request.resource.data &&
                      request.resource.data.content is string &&
                      request.resource.data.content.size() > 0 &&
                      request.resource.data.content.size() <= 1000 &&
                      'category' in request.resource.data &&
                      'authorId' in request.resource.data &&
                      'authorDisplay' in request.resource.data &&
                      request.resource.data.authorId == request.auth.uid &&
                      hasNoProhibitedWordsPublic(request.resource.data.title.lower()) &&
                      hasNoProhibitedWordsPublic(request.resource.data.content.lower());

      allow update: if isAuthenticated() &&
                      resource.data.authorId == request.auth.uid &&
                      request.resource.data.authorId == resource.data.authorId &&
                      hasNoProhibitedWordsPublic(request.resource.data.title.lower()) &&
                      hasNoProhibitedWordsPublic(request.resource.data.content.lower());

      allow delete: if isAuthenticated() &&
                      resource.data.authorId == request.auth.uid;
    }

    match /forum_replies/{replyId} {
      allow read: if true;

      // âœ… foro pÃºblico: filtro fuerte
      allow create: if isAuthenticated() &&
                      !isAnonymous() &&
                      'threadId' in request.resource.data &&
                      'content' in request.resource.data &&
                      request.resource.data.content is string &&
                      request.resource.data.content.size() > 0 &&
                      request.resource.data.content.size() <= 1000 &&
                      'authorId' in request.resource.data &&
                      'authorDisplay' in request.resource.data &&
                      request.resource.data.authorId == request.auth.uid &&
                      hasNoProhibitedWordsPublic(request.resource.data.content.lower());

      allow update: if isAuthenticated() &&
                      resource.data.authorId == request.auth.uid &&
                      request.resource.data.authorId == resource.data.authorId &&
                      hasNoProhibitedWordsPublic(request.resource.data.content.lower());

      allow delete: if isAuthenticated() &&
                      resource.data.authorId == request.auth.uid;
    }

    // ===========================
    // ACTIVIDAD GLOBAL
    // ===========================

    match /globalActivity/{userId} {
      allow read: if true;

      allow create, update: if isAuthenticated() &&
                              request.auth.uid == userId &&
                              'userId' in request.resource.data &&
                              request.resource.data.userId == userId;

      allow delete: if false;
    }

    // ===========================
    // OPIN - DISCOVERY WALL
    // ===========================

    match /opin_posts/{postId} {
      // âœ… Lectura pÃºblica - cualquiera puede ver posts (incluso sin autenticaciÃ³n)
      allow read: if true;

      // Crear: usuarios registrados sin isStable, o admin con isStable (OPIN estables)
      allow create: if (
        (isRegistered() &&
         'userId' in request.resource.data &&
         request.resource.data.userId == request.auth.uid &&
         'text' in request.resource.data &&
         request.resource.data.text is string &&
         request.resource.data.text.size() >= 10 &&
         request.resource.data.text.size() <= 500 &&
         (!('isStable' in request.resource.data) || request.resource.data.isStable == false))
        ||
        (isAdmin() &&
         'userId' in request.resource.data &&
         request.resource.data.userId == request.auth.uid &&
         'text' in request.resource.data &&
         request.resource.data.text is string &&
         request.resource.data.text.size() >= 10 &&
         request.resource.data.text.size() <= 500)
      );

      // Actualizar: propietario o admin (para likes, views, OPIN estables, etc.)
      allow update: if isAuthenticated() &&
                      (resource.data.userId == request.auth.uid || isAdmin());

      // Eliminar: propietario o admin (admin gestiona OPIN estables)
      allow delete: if isAuthenticated() &&
                      (resource.data.userId == request.auth.uid || isAdmin());
    }

    match /opin_comments/{commentId} {
      // âœ… Lectura pÃºblica
      allow read: if true;

      // Crear: solo usuarios registrados
      allow create: if isRegistered() &&
                      'userId' in request.resource.data &&
                      request.resource.data.userId == request.auth.uid &&
                      'comment' in request.resource.data &&
                      request.resource.data.comment is string &&
                      request.resource.data.comment.size() > 0 &&
                      request.resource.data.comment.size() <= 500;

      // Eliminar: solo el autor
      allow delete: if isAuthenticated() &&
                      resource.data.userId == request.auth.uid;
    }

    // Registro de acciones de OPIN (para lÃ­mite de 4 en 24h)
    match /opin_actions/{actionId} {
      // Leer: solo el propietario de la acciÃ³n
      allow read: if isAuthenticated() &&
                    resource.data.userId == request.auth.uid;

      // Crear: usuarios registrados
      allow create: if isRegistered() &&
                      'userId' in request.resource.data &&
                      request.resource.data.userId == request.auth.uid &&
                      'actionType' in request.resource.data &&
                      request.resource.data.actionType in ['edit', 'delete'] &&
                      'postId' in request.resource.data;

      // No se puede editar ni eliminar
      allow update, delete: if false;
    }

    // ===========================
    // RECOMPENSAS
    // ===========================

    match /rewards/{rewardId} {
      allow read: if isAdmin() ||
                     (isAuthenticated() && resource.data.userId == request.auth.uid);

      allow create: if isAdmin() &&
                      'userId' in request.resource.data &&
                      'username' in request.resource.data &&
                      'type' in request.resource.data &&
                      'reason' in request.resource.data &&
                      'issuedBy' in request.resource.data &&
                      request.resource.data.issuedBy == request.auth.uid &&
                      'status' in request.resource.data &&
                      request.resource.data.status == 'active';

      allow update: if isAdmin();

      allow delete: if false;
    }

    // ===========================
    // RATE LIMITING - USUARIOS MUTEADOS
    // ===========================

    match /muted_users/{userId} {
      // Leer: cualquier usuario autenticado puede verificar si estÃ¡ muteado
      allow read: if isAuthenticated();

      // Crear/Actualizar: cualquier usuario autenticado puede mutear (sistema automÃ¡tico)
      // El userId del documento DEBE coincidir con el campo userId en los datos
      allow create, update: if isAuthenticated() &&
                              'userId' in request.resource.data &&
                              request.resource.data.userId is string &&
                              'muteEnd' in request.resource.data &&
                              'reason' in request.resource.data;

      // Borrar: solo admin puede eliminar mutes manualmente
      allow delete: if isAdmin();
    }

    // ===========================
    // ALERTAS DE MODERACIÃ“N (NUEVO)
    // ===========================

    match /moderation_alerts/{alertId} {
      // Leer: solo admins
      allow read: if isAdmin();

      // Crear: sistema de moderaciÃ³n (usuarios autenticados pueden crear alertas)
      allow create: if isAuthenticated() &&
                      'type' in request.resource.data &&
                      request.resource.data.type in ['hate_speech', 'offensive', 'suicide', 'self_harm', 'harassment'] &&
                      'userId' in request.resource.data &&
                      'username' in request.resource.data &&
                      'message' in request.resource.data &&
                      'roomId' in request.resource.data &&
                      'severity' in request.resource.data &&
                      request.resource.data.severity in ['low', 'medium', 'high', 'critical'] &&
                      'status' in request.resource.data &&
                      request.resource.data.status == 'pending' &&
                      'createdAt' in request.resource.data;

      // Actualizar: solo admins (para cambiar status, agregar notas, etc.)
      allow update: if isAdmin();

      // Eliminar: solo admins
      allow delete: if isAdmin();
    }

    // ===========================
    // BAÃšL DE TARJETAS (Sistema de Perfiles Sociales)
    // ===========================

    match /tarjetas/{odIdUsuari} {
      // Leer: Cualquier usuario autenticado puede ver tarjetas
      allow read: if isAuthenticated();

      // Crear: Solo el dueÃ±o puede crear su propia tarjeta
      allow create: if isAuthenticated() && request.auth.uid == odIdUsuari;

      // Actualizar: El dueÃ±o puede actualizar su info,
      // OTROS usuarios pueden actualizar solo campos de interacciÃ³n (likes, visitas)
      allow update: if isAuthenticated() && (
        // El dueÃ±o puede actualizar todo
        request.auth.uid == odIdUsuari ||
        // Otros usuarios solo pueden modificar campos de interacciÃ³n
        (
          request.resource.data.diff(resource.data).affectedKeys()
            .hasOnly(['likesRecibidos', 'likesDe', 'visitasRecibidas', 'visitasDe', 'mensajesRecibidos', 'actividadNoLeida', 'actualizadaEn'])
        )
      );

      // Eliminar: Solo el dueÃ±o o admin
      allow delete: if isOwner(odIdUsuari) || isAdmin();

      // SubcolecciÃ³n de actividad (likes, mensajes, visitas recibidas)
      match /actividad/{actividadId} {
        // Leer: Solo el dueÃ±o de la tarjeta puede ver su actividad
        allow read: if isAuthenticated() && request.auth.uid == odIdUsuari;

        // Crear: Cualquier usuario autenticado puede dejar actividad (like, mensaje, visita)
        allow create: if isAuthenticated() && request.auth.uid != odIdUsuari;

        // Actualizar: Solo el dueÃ±o puede marcar como leÃ­da
        allow update: if isAuthenticated() && request.auth.uid == odIdUsuari;

        // Eliminar: Solo el dueÃ±o o admin
        allow delete: if isOwner(odIdUsuari) || isAdmin();
      }
    }

    // ===========================
    // MATCHES (BAÃšL)
    // ===========================

    match /matches/{matchId} {
      // Leer: participantes (o cualquier registrado si el doc no existe aÃºn)
      allow read: if isRegistered() &&
                    (resource == null || request.auth.uid in resource.data.users);

      // Crear: solo participantes, estructura mÃ­nima
      allow create: if isRegistered() &&
                      request.resource.data.keys().hasAll(['users', 'userA', 'userB', 'createdAt', 'status']) &&
                      request.resource.data.users.size() == 2 &&
                      request.auth.uid in request.resource.data.users;

      // Actualizar: solo participantes
      allow update: if isRegistered() &&
                      request.auth.uid in resource.data.users;

      // Eliminar: solo admin o participantes
      allow delete: if isAdmin() ||
                      (isRegistered() && request.auth.uid in resource.data.users);
    }

    // ===========================
    // SPAM WARNINGS (Para tracking de nÃºmeros sanitizados)
    // ===========================

    match /spam_warnings/{odIdUsuari} {
      // Solo el sistema puede escribir (via el usuario autenticado)
      allow read: if isAdmin();
      allow create, update: if isAuthenticated() && request.auth.uid == odIdUsuari;
      allow delete: if isAdmin();
    }

    // ===========================
    // ðŸ“… EVENTOS PROGRAMADOS
    // ===========================

    match /eventos/{eventoId} {
      // Lectura: cualquiera puede ver eventos
      allow read: if true;
      // Crear/editar: solo admin
      allow create, update: if isAdmin();
      // Eliminar: solo admin
      allow delete: if isAdmin();

      // Asistentes del evento
      match /asistentes/{userId} {
        allow read: if true;
        allow create, update: if isAuthenticated();
        allow delete: if isAuthenticated() && request.auth.uid == userId;
      }
    }

    // ===========================
    // ðŸ¤– MODERACIÃ“N IA - Estado de usuarios
    // ===========================

    match /userModerationState/{userId} {
      // Leer: el propio usuario o admin
      allow read: if isAuthenticated() &&
                    (request.auth.uid == userId || isAdmin());

      // Crear/Actualizar: el propio usuario (sistema client-side) o admin
      allow create, update: if isAuthenticated() &&
                              (request.auth.uid == userId || isAdmin()) &&
                              'strikes' in request.resource.data &&
                              request.resource.data.strikes is int;

      // No se permite borrar (historial permanente)
      allow delete: if isAdmin();
    }

    // ðŸ¤– MODERACIÃ“N IA - Logs de moderaciÃ³n
    match /moderationLogs/{logId} {
      // Leer: solo admin
      allow read: if isAdmin();

      // Crear: cualquier usuario autenticado (el sistema escribe en su nombre)
      allow create: if isAuthenticated() &&
                      'userId' in request.resource.data &&
                      'message' in request.resource.data &&
                      'result' in request.resource.data;

      // No se puede editar ni borrar logs
      allow update, delete: if false;
    }

    // ===========================
    // âœ¨ ESENCIAS (presencia asÃ­ncrona de 5 minutos)
    // ===========================

    match /esencias/{esenciaId} {
      // Lectura pÃºblica para reforzar sensaciÃ³n de actividad
      allow read: if true;

      // Crear: usuarios autenticados (incluye invitados anÃ³nimos de Firebase Auth)
      allow create: if isAuthenticated() &&
                      'esenciaId' in request.resource.data &&
                      request.resource.data.esenciaId == esenciaId &&
                      'userId' in request.resource.data &&
                      request.resource.data.userId == request.auth.uid &&
                      'username' in request.resource.data &&
                      request.resource.data.username is string &&
                      request.resource.data.username.size() >= 2 &&
                      request.resource.data.username.size() <= 30 &&
                      'mensaje' in request.resource.data &&
                      request.resource.data.mensaje is string &&
                      request.resource.data.mensaje.size() >= 3 &&
                      request.resource.data.mensaje.size() <= 120 &&
                      'createdAt' in request.resource.data &&
                      request.resource.data.createdAt is timestamp &&
                      'expiresAt' in request.resource.data &&
                      request.resource.data.expiresAt is timestamp;

      // No se permite editar esencia (inmutable)
      allow update: if false;

      // Borrado: dueÃ±o o admin
      allow delete: if isAuthenticated() &&
                      (resource.data.userId == request.auth.uid || isAdmin());
    }

    // ===========================
    // DEFAULT: CERRADO
    // ===========================

    match /{document=**} {
      allow read, write: if false;
    }

  }
}
