rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ===========================
    // FUNCIONES AUXILIARES
    // ===========================

    function isAuthenticated() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    function isPremium() {
      return isAuthenticated() &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isPremium == true;
    }

    // Admin por campo role en /users/{uid}
    function isAdmin() {
      return isAuthenticated() &&
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.keys().hasAny(['role']) &&
             (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin' || 
              get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'administrator');
    }

    // ✅ NUEVO: Admin o Support (para sistema de tickets)
    function isAdminOrSupport() {
      return isAuthenticated() &&
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.keys().hasAny(['role']) &&
             (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin' || 
              get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'administrator' ||
              get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'support');
    }

    // ✅ SUPER ADMIN: Verificación por email como capa extra de seguridad
    function isSuperAdmin() {
      return isAuthenticated() &&
             request.auth.token.email == 'caribenosvenezolanos@gmail.com';
    }

    // ✅ Admin verificado: Debe tener rol Y ser del email autorizado
    function isVerifiedAdmin() {
      return isSuperAdmin() || isAdmin();
    }

    // Provider anonymous
    function isAnonymous() {
      return isAuthenticated() && request.auth.token.firebase.sign_in_provider == 'anonymous';
    }

    // ===========================
    // FILTROS DE CONTENIDO
    // ===========================

    // ✅ PUBLICO: bloqueo fuerte (spam + insultos + drogas + contacto externo)
    function hasNoProhibitedWordsPublic(content) {
      let prohibitedPublic = [
        // spam/estafas/hack
        'spam', 'phishing', 'scam', 'hack', 'viagra',
        // insultos / ataques
        'puto', 'maricon', 'sidoso', 'enfermo', 'degenerado',
        // drogas / ilegal
        'drogas', 'coca', 'perico', 'sexopago', 'escort',
        // contacto externo / doxxing
        'whatsapp', 'instagram', 'telegram',
        'numero', 'número', 'telefono', 'teléfono',
        'llamame', 'llámame', 'escribeme', 'escríbeme',
        'dm', 'directo', 'mensaje privado',
        'correo', 'email', 'gmail',
        '@'
      ];
      return !content.matches('.*(' + prohibitedPublic.join('|') + ').*');
    }

    // ✅ PRIVADO: SOLO bloqueo insultos + spam/estafas/hack
    function hasNoProhibitedWordsPrivate(content) {
      let prohibitedPrivate = [
        // spam/estafas/hack
        'spam', 'phishing', 'scam', 'hack', 'viagra',
        // insultos / ataques
        'puto', 'maricon', 'sidoso', 'enfermo', 'degenerado'
      ];
      return !content.matches('.*(' + prohibitedPrivate.join('|') + ').*');
    }

    // ===========================
    // VALIDACIONES DE MENSAJES
    // ===========================

    function isValidMessage() {
      let data = request.resource.data;
      // ✅ Seguridad: userId SIEMPRE debe coincidir con el uid del auth
      // Campos mínimos Y validación de seguridad
      return isAuthenticated() &&
             'userId' in data &&
             data.userId == request.auth.uid &&
             'username' in data &&
             data.username is string &&
             'content' in data &&
             data.content is string &&
             data.content.size() > 0 &&
             data.content.size() <= 1000 &&
             'type' in data &&
             data.type in ['text', 'image', 'voice', 'system'] &&
             'timestamp' in data &&
             data.timestamp is timestamp;
    }

    // ✅ ACTUALIZADO: Permitir mensajes bot desde cliente (sistema de IA conversacional)
    // Seguridad: validación por patrón de userId (bot_*) y autenticación requerida
    function isValidBotMessage() {
      let data = request.resource.data;
      return isAuthenticated() &&
             'userId' in data &&
             data.userId is string &&
             data.userId.matches('bot_.*') &&
             'username' in data && data.username is string &&
             'content' in data && data.content is string &&
             data.content.size() > 0 &&
             data.content.size() <= 1000 &&
             'type' in data && data.type in ['text', 'image', 'voice', 'system'] &&
             'timestamp' in data && data.timestamp is timestamp;
    }

    function isAdult(age) {
      return age == null || (age is number && age >= 18);
    }

    // ===========================
    // REGLAS DE INVITADOS (ANÓNIMOS)
    // ===========================

    match /guests/{guestId} {
      allow read, write: if isAuthenticated() &&
                           request.auth.uid == guestId &&
                           request.auth.token.firebase.sign_in_provider == 'anonymous';
    }

    // ===========================
    // REGLAS DE USUARIOS
    // ===========================

    match /users/{userId} {
      // ✅ SUPER ADMIN puede leer cualquier usuario, otros solo si están autenticados
      allow read: if isSuperAdmin() || isAuthenticated();

      allow create: if isOwner(userId) &&
                      request.resource.data.username is string &&
                      request.resource.data.username.size() >= 3 &&
                      request.resource.data.username.size() <= 30 &&
                      request.resource.data.email is string &&
                      request.resource.data.isPremium == false &&
                      request.resource.data.verified == false &&
                      isAdult(request.resource.data.get('age', null));

      allow update: if isOwner(userId) &&
                      request.resource.data.email == resource.data.email &&
                      request.resource.data.id == resource.data.id &&
                      request.resource.data.isPremium == resource.data.isPremium;

      allow delete: if isOwner(userId);

      // Subcolección de notificaciones del usuario
      match /notifications/{notificationId} {
        allow read: if isOwner(userId);

        // ✅ CRÍTICO: Admin/Support pueden crear notificaciones para usuarios (respuestas a tickets, etc.)
        allow create: if isSuperAdmin() || isAdminOrSupport() || isOwner(userId);

        allow update: if isOwner(userId);

        allow delete: if isOwner(userId);
      }
    }

    // ===========================
    // REGLAS DE PRESENCIA
    // ===========================

    match /roomPresence/{roomId}/users/{userId} {
      // Si quieres presencia pública total: cambia a `if true;`
      allow read: if isAuthenticated();

      // ✅ Permitir usuarios anónimos también para presencia (necesario para el chat)
      allow create, update, delete: if isAuthenticated() &&
                                      request.auth.uid == userId;
    }

    // ===========================
    // REGLAS DE SALAS Y MENSAJES (PUBLICO)
    // ===========================

    // ✅ CRÍTICO: Permitir lectura de documentos de sala
    match /rooms/{roomId} {
      // Cualquiera puede leer información de la sala (nombre, descripción, etc.)
      allow read: if true;

      // Solo admins pueden crear/modificar salas
      allow write: if isAdmin();
    }

    match /rooms/{roomId}/messages/{messageId} {
      // ✅ CRÍTICO: Permitir lectura pública para SEO y UX
      // Cualquiera puede VER las conversaciones (incluso sin registro)
      // Esto permite que usuarios que lleguen desde Google puedan ver el chat
      allow read: if true;

      // ✅ Publico: filtro fuerte (incluye contacto)
      // ✅ ACTUALIZADO: Permitir usuarios anónimos (limitados por sistema de 1 hora en cliente)
      allow create: if isAuthenticated() &&
                      (
                        (isValidMessage() &&
                         hasNoProhibitedWordsPublic(request.resource.data.content.lower()))
                        ||
                        // Bot messages: cualquier usuario autenticado puede enviar bots
                        (isValidBotMessage() &&
                         hasNoProhibitedWordsPublic(request.resource.data.content.lower()))
                      );

      allow update: if isAuthenticated() &&
                      request.resource.data.content == resource.data.content &&
                      request.resource.data.userId == resource.data.userId &&
                      request.resource.data.timestamp == resource.data.timestamp &&
                      request.resource.data.diff(resource.data).affectedKeys().hasOnly(['reactions']);

      allow delete: if isAuthenticated() &&
                      resource.data.userId == request.auth.uid;
    }

    // ===========================
    // REGLAS DE CHATS PRIVADOS
    // ===========================

    match /privateChats/{chatId} {
      allow read: if isAuthenticated() &&
                    request.auth.uid in resource.data.participants;

      allow create: if isAuthenticated() &&
                      request.resource.data.keys().hasAll(['participants', 'createdAt']) &&
                      request.auth.uid in request.resource.data.participants &&
                      request.resource.data.participants.size() == 2;

      match /messages/{messageId} {
        allow read: if isAuthenticated() &&
                      request.auth.uid in get(/databases/$(database)/documents/privateChats/$(chatId)).data.participants;

        // ✅ PRIVADO: se permite contacto/numero/redes, SOLO bloqueo insultos+spam
        allow create: if isAuthenticated() &&
                        request.auth.uid in get(/databases/$(database)/documents/privateChats/$(chatId)).data.participants &&
                        isValidMessage() &&
                        hasNoProhibitedWordsPrivate(request.resource.data.content.lower());
      }
    }

    // ===========================
    // REPORTES/DENUNCIAS
    // ===========================

    match /reports/{reportId} {
      allow read: if isAdmin() ||
                    (isAuthenticated() && resource.data.reporterId == request.auth.uid);

      allow create: if isAuthenticated() &&
                      'reporterId' in request.resource.data &&
                      request.resource.data.reporterId == request.auth.uid &&
                      'type' in request.resource.data &&
                      'description' in request.resource.data &&
                      request.resource.data.description is string &&
                      request.resource.data.description.size() > 10 &&
                      'targetUsername' in request.resource.data &&
                      'status' in request.resource.data &&
                      request.resource.data.status == 'pending';

      allow update: if isAdmin();

      allow delete: if false;
    }

    // ===========================
    // ANALYTICS
    // ===========================

    match /analytics_stats/{dateId} {
      // ✅ Permitir que usuarios autenticados escriban en analytics (para tracking de eventos)
      // Los usuarios solo pueden escribir en documentos que coincidan con su userId o fecha actual
      allow write: if isAuthenticated() && 
                      (isAdmin() || 
                       dateId == request.auth.uid || 
                       dateId.matches('\\d{4}-\\d{2}-\\d{2}'));
      allow read: if isAuthenticated();
    }

    // ===========================
    // CONEXIONES DE USUARIO
    // ===========================

    match /user_connections/{userId} {
      allow read: if isAuthenticated() && request.auth.uid == userId;

      allow create: if isAuthenticated() &&
                      request.auth.uid == userId &&
                      'userId' in request.resource.data &&
                      request.resource.data.userId == userId;

      allow update: if isAuthenticated() &&
                      request.auth.uid == userId &&
                      resource.data.userId == userId;

      allow delete: if false;
    }

    // ===========================
    // SANCIONES
    // ===========================

    match /sanctions/{sanctionId} {
      allow read: if isAdmin() ||
                    (isAuthenticated() &&
                     resource.data.userId == request.auth.uid &&
                     resource.data.status == 'active');

      allow create: if isAdmin() &&
                      'userId' in request.resource.data &&
                      'type' in request.resource.data &&
                      'reason' in request.resource.data &&
                      'issuedBy' in request.resource.data &&
                      request.resource.data.issuedBy == request.auth.uid &&
                      'status' in request.resource.data &&
                      request.resource.data.status == 'active';

      allow update: if isAdmin();

      allow delete: if false;
    }

    // ===========================
    // NOTIFICACIONES DEL SISTEMA
    // ===========================

    match /systemNotifications/{notificationId} {
      allow read: if isAuthenticated() &&
                    resource.data.userId == request.auth.uid;

      allow create: if isAdmin() &&
                      'userId' in request.resource.data &&
                      'title' in request.resource.data &&
                      'message' in request.resource.data &&
                      'type' in request.resource.data &&
                      'read' in request.resource.data &&
                      request.resource.data.read == false;

      allow update: if (isAuthenticated() &&
                       resource.data.userId == request.auth.uid &&
                       request.resource.data.userId == resource.data.userId &&
                       request.resource.data.title == resource.data.title &&
                       request.resource.data.message == resource.data.message &&
                       request.resource.data.diff(resource.data).affectedKeys().hasOnly(['read', 'readAt'])) ||
                      isAdmin();

      allow delete: if false;
    }

    // ===========================
    // TICKETS
    // ===========================

    match /tickets/{ticketId} {
      // ✅ CRÍTICO: Para queries a nivel de colección, admins necesitan acceso sin restricción
      // Los usuarios normales solo pueden leer sus propios tickets (verificado en el documento)
      allow read: if isSuperAdmin() || 
                    isAdminOrSupport() ||
                    (isAuthenticated() && resource.data.userId == request.auth.uid) ||
                    (isAuthenticated() && resource.data.userUid == request.auth.uid);

      allow create: if isAuthenticated() &&
                      'userId' in request.resource.data &&
                      request.resource.data.userId == request.auth.uid &&
                      'subject' in request.resource.data &&
                      'description' in request.resource.data &&
                      'category' in request.resource.data &&
                      'priority' in request.resource.data &&
                      'status' in request.resource.data &&
                      request.resource.data.status == 'open';

      allow update: if isSuperAdmin() || isAdminOrSupport();

      allow delete: if false;

      // ✅ NUEVO: Mensajes del ticket (conversación)
      match /messages/{messageId} {
        // Leer: super admin, admin/support o dueño del ticket
        allow read: if isSuperAdmin() ||
                      isAdminOrSupport() ||
                      (isAuthenticated() &&
                       get(/databases/$(database)/documents/tickets/$(ticketId)).data.userId == request.auth.uid);

        // Crear: super admin o admin/support puede enviar mensajes
        allow create: if (isSuperAdmin() || isAdminOrSupport()) &&
                        'type' in request.resource.data &&
                        request.resource.data.type in ['external', 'internal'] &&
                        'author' in request.resource.data &&
                        'authorUid' in request.resource.data &&
                        'authorUsername' in request.resource.data &&
                        'body' in request.resource.data &&
                        request.resource.data.body is string &&
                        request.resource.data.body.size() > 0 &&
                        'createdAt' in request.resource.data;

        // No se permite editar o borrar mensajes
        allow update, delete: if false;
      }

      // ✅ NUEVO: Logs de auditoría del ticket
      match /logs/{logId} {
        // Leer: super admin o admin/support
        allow read: if isSuperAdmin() || isAdminOrSupport();

        // Crear: super admin o admin/support
        allow create: if (isSuperAdmin() || isAdminOrSupport()) &&
                        'action' in request.resource.data &&
                        'actorUid' in request.resource.data &&
                        'actorRole' in request.resource.data &&
                        'createdAt' in request.resource.data;

        // No se permite editar o borrar logs
        allow update, delete: if false;
      }
    }

    // ===========================
    // ÍNDICE DE USERNAMES
    // ===========================

    // ✅ NUEVO: Índice para validar disponibilidad de usernames
    match /usernames/{usernameLower} {
      // Leer: todos los autenticados (para validar disponibilidad)
      allow read: if isAuthenticated();

      // Crear/Actualizar/Borrar: solo admin (operaciones de cambio de username)
      allow create, update, delete: if isAdmin();
    }

    // ===========================
    // LOGS GLOBALES DE ADMIN
    // ===========================

    // ✅ NUEVO: Logs de todas las acciones administrativas
    match /admin_logs/{logId} {
      // Leer: solo admin
      allow read: if isAdmin();

      // Crear: solo admin
      allow create: if isAdmin() &&
                      'action' in request.resource.data &&
                      'adminUid' in request.resource.data &&
                      'adminUsername' in request.resource.data &&
                      'createdAt' in request.resource.data;

      // No se permite editar o borrar logs
      allow update, delete: if false;
    }

    // ===========================
    // FORO PUBLICO (MUY ESTRICTO)
    // ===========================

    match /forum_threads/{threadId} {
      allow read: if true;

      // ✅ foro público: prohibido contacto + etc (filtro fuerte)
      allow create: if isAuthenticated() &&
                      !isAnonymous() &&
                      'title' in request.resource.data &&
                      request.resource.data.title is string &&
                      request.resource.data.title.size() > 0 &&
                      request.resource.data.title.size() <= 100 &&
                      'content' in request.resource.data &&
                      request.resource.data.content is string &&
                      request.resource.data.content.size() > 0 &&
                      request.resource.data.content.size() <= 1000 &&
                      'category' in request.resource.data &&
                      'authorId' in request.resource.data &&
                      'authorDisplay' in request.resource.data &&
                      request.resource.data.authorId == request.auth.uid &&
                      hasNoProhibitedWordsPublic(request.resource.data.title.lower()) &&
                      hasNoProhibitedWordsPublic(request.resource.data.content.lower());

      allow update: if isAuthenticated() &&
                      resource.data.authorId == request.auth.uid &&
                      request.resource.data.authorId == resource.data.authorId &&
                      hasNoProhibitedWordsPublic(request.resource.data.title.lower()) &&
                      hasNoProhibitedWordsPublic(request.resource.data.content.lower());

      allow delete: if isAuthenticated() &&
                      resource.data.authorId == request.auth.uid;
    }

    match /forum_replies/{replyId} {
      allow read: if true;

      // ✅ foro público: filtro fuerte
      allow create: if isAuthenticated() &&
                      !isAnonymous() &&
                      'threadId' in request.resource.data &&
                      'content' in request.resource.data &&
                      request.resource.data.content is string &&
                      request.resource.data.content.size() > 0 &&
                      request.resource.data.content.size() <= 1000 &&
                      'authorId' in request.resource.data &&
                      'authorDisplay' in request.resource.data &&
                      request.resource.data.authorId == request.auth.uid &&
                      hasNoProhibitedWordsPublic(request.resource.data.content.lower());

      allow update: if isAuthenticated() &&
                      resource.data.authorId == request.auth.uid &&
                      request.resource.data.authorId == resource.data.authorId &&
                      hasNoProhibitedWordsPublic(request.resource.data.content.lower());

      allow delete: if isAuthenticated() &&
                      resource.data.authorId == request.auth.uid;
    }

    // ===========================
    // ACTIVIDAD GLOBAL
    // ===========================

    match /globalActivity/{userId} {
      allow read: if true;

      allow create, update: if isAuthenticated() &&
                              request.auth.uid == userId &&
                              'userId' in request.resource.data &&
                              request.resource.data.userId == userId;

      allow delete: if false;
    }

    // ===========================
    // RECOMPENSAS
    // ===========================

    match /rewards/{rewardId} {
      allow read: if isAdmin() ||
                     (isAuthenticated() && resource.data.userId == request.auth.uid);

      allow create: if isAdmin() &&
                      'userId' in request.resource.data &&
                      'username' in request.resource.data &&
                      'type' in request.resource.data &&
                      'reason' in request.resource.data &&
                      'issuedBy' in request.resource.data &&
                      request.resource.data.issuedBy == request.auth.uid &&
                      'status' in request.resource.data &&
                      request.resource.data.status == 'active';

      allow update: if isAdmin();

      allow delete: if false;
    }

    // ===========================
    // DEFAULT: CERRADO
    // ===========================

    match /{document=**} {
      allow read, write: if false;
    }

  }
}
