rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ===========================
    // FUNCIONES AUXILIARES
    // ===========================

    // Verificar si el usuario está autenticado
    function isAuthenticated() {
      return request.auth != null;
    }

    // Verificar si el usuario es el propietario del recurso
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // Verificar si el usuario es Premium
    function isPremium() {
      return isAuthenticated() &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isPremium == true;
    }

    // ✅ AÑADIDO 2025-12-11: Verificar si el usuario es Admin
    function isAdmin() {
      return isAuthenticated() &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.get('role', '') == 'admin';
    }

    // Verificar si el mensaje es de un bot (userId comienza con 'bot_')
    function isBot() {
      let data = request.resource.data;
      return 'userId' in data &&
             data.userId is string &&
             data.userId.matches('bot_.*');
    }

    // Validar datos de mensaje
    function isValidMessage() {
      let data = request.resource.data;
      // Solo validar que tenga los campos mínimos requeridos (permite campos adicionales)
      return 'userId' in data &&
             // Permitir bots (userId empieza con 'bot_') o usuario autenticado
             (data.userId.matches('bot_.*') || data.userId == request.auth.uid) &&
             'username' in data && data.username is string &&
             'content' in data && data.content is string &&
             data.content.size() > 0 &&
             data.content.size() <= 1000 && // Máximo 1000 caracteres
             'type' in data && data.type in ['text', 'image', 'voice', 'system'] &&
             'timestamp' in data && data.timestamp is timestamp;
    }

    // ✅ CORREGIDO 2025-12-11: Filtro expandido de palabras prohibidas
    function hasNoProhibitedWords(content) {
      // Lista expandida de palabras sensibles (contenido inapropiado, spam, contacto externo)
      let prohibited = [
        'spam', 'phishing', 'scam', 'hack', 'viagra',
        'puto', 'maricon', 'sidoso', 'enfermo', 'degenerado',
        'whatsapp', 'instagram', 'telegram', 'numero', 'telefono',
        'drogas', 'coca', 'perico', 'sexopago', 'escort',
        'menor', 'niño', 'adolescente', 'joven18'
      ];
      return !content.matches('.*(' + prohibited.join('|') + ').*');
    }

    // Validar edad del usuario (null es válido si no se proporciona)
    function isAdult(age) {
      return age == null || (age is number && age >= 18);
    }

    // ===========================
    // REGLAS DE INVITADOS (ANÓNIMOS)
    // ===========================

    match /guests/{guestId} {
      // Un invitado solo puede leer y modificar su propio contador
      allow read, write: if request.auth != null &&
                           request.auth.uid == guestId &&
                           request.auth.token.firebase.sign_in_provider == 'anonymous';
    }

    // ===========================
    // REGLAS DE USUARIOS
    // ===========================

    match /users/{userId} {
      // Lectura: cualquier usuario autenticado puede leer perfiles
      allow read: if isAuthenticated();

      // Creación: solo al registrarse, con validaciones básicas
      allow create: if isOwner(userId) &&
                      request.resource.data.username is string &&
                      request.resource.data.username.size() >= 3 &&
                      request.resource.data.username.size() <= 30 &&
                      request.resource.data.email is string &&
                      request.resource.data.isPremium == false && // Nuevo usuario no puede ser premium
                      request.resource.data.verified == false &&
                      isAdult(request.resource.data.get('age', null));

      // Actualización: solo el propietario, con restricciones
      allow update: if isOwner(userId) &&
                      // No puede cambiar email ni id
                      request.resource.data.email == resource.data.email &&
                      request.resource.data.id == resource.data.id &&
                      // ✅ CORREGIDO 2025-12-11: No puede cambiar isPremium (solo mediante admin/Cloud Function)
                      request.resource.data.isPremium == resource.data.isPremium;

      // Eliminación: solo el propietario
      allow delete: if isOwner(userId);

      // Subcolección de notificaciones del usuario
      match /notifications/{notificationId} {
        // Solo el usuario puede leer sus propias notificaciones
        allow read: if isOwner(userId);

        // Cualquier usuario autenticado puede crear notificaciones para otros
        allow create: if isAuthenticated();

        // Solo el usuario puede actualizar (marcar como leída) sus notificaciones
        allow update: if isOwner(userId);

        // Solo el usuario puede eliminar sus notificaciones
        allow delete: if isOwner(userId);
      }
    }

    // ===========================
    // REGLAS DE PRESENCIA (Usuarios Conectados)
    // ===========================

    match /roomPresence/{roomId}/users/{userId} {
      // ✅ CORREGIDO 2025-12-11: Solo usuarios autenticados pueden ver presencia (privacidad)
      allow read: if isAuthenticated();

      // Solo el propio usuario puede crear/actualizar/eliminar su presencia
      allow create, update, delete: if request.auth != null &&
                                      request.auth.uid == userId;
    }

    // ===========================
    // REGLAS DE SALAS Y MENSAJES
    // ===========================

    match /rooms/{roomId}/messages/{messageId} {
      // Lectura: cualquier usuario (autenticado o invitado)
      allow read: if true;

      // Creación: usuario autenticado con validaciones
      allow create: if isAuthenticated() &&
                      isValidMessage() &&
                      hasNoProhibitedWords(request.resource.data.content.lower()) &&
                      // Si es anónimo, debe tener menos de 3 mensajes
                      (request.auth.token.firebase.sign_in_provider != 'anonymous' ||
                       !exists(/databases/$(database)/documents/guests/$(request.auth.uid)) ||
                       get(/databases/$(database)/documents/guests/$(request.auth.uid)).data.messageCount < 3);

      // Actualización: solo usuarios autenticados para reacciones
      allow update: if isAuthenticated() &&
                      // No se puede cambiar el contenido del mensaje
                      request.resource.data.content == resource.data.content &&
                      request.resource.data.userId == resource.data.userId &&
                      request.resource.data.timestamp == resource.data.timestamp &&
                      // Solo se pueden actualizar las reacciones
                      request.resource.data.diff(resource.data).affectedKeys().hasOnly(['reactions']);

      // Eliminación: solo el autor
      allow delete: if isAuthenticated() &&
                      resource.data.userId == request.auth.uid;
    }

    // ===========================
    // REGLAS DE CHATS PRIVADOS
    // ===========================

    match /privateChats/{chatId} {
      // Solo los participantes pueden leer
      allow read: if isAuthenticated() &&
                    request.auth.uid in resource.data.participants;

      // Crear chat privado: ambos usuarios deben estar autenticados
      allow create: if isAuthenticated() &&
                      request.resource.data.keys().hasAll(['participants', 'createdAt']) &&
                      request.auth.uid in request.resource.data.participants &&
                      request.resource.data.participants.size() == 2;

      // Mensajes dentro de chats privados
      match /messages/{messageId} {
        // Solo los participantes del chat pueden leer
        allow read: if isAuthenticated() &&
                      request.auth.uid in get(/databases/$(database)/documents/privateChats/$(chatId)).data.participants;

        // Solo los participantes pueden enviar mensajes
        allow create: if isAuthenticated() &&
                        request.auth.uid in get(/databases/$(database)/documents/privateChats/$(chatId)).data.participants &&
                        isValidMessage();
      }
    }

    // ===========================
    // REGLAS DE REPORTES/DENUNCIAS
    // ===========================

    match /reports/{reportId} {
      // ✅ CORREGIDO 2025-12-11: Admins y reportador pueden leer reportes
      allow read: if isAdmin() ||
                    (isAuthenticated() && resource.data.reporterId == request.auth.uid);

      // Usuarios autenticados pueden crear reportes
      allow create: if isAuthenticated() &&
                      'reporterId' in request.resource.data &&
                      request.resource.data.reporterId == request.auth.uid &&
                      'type' in request.resource.data &&
                      'description' in request.resource.data &&
                      request.resource.data.description is string &&
                      request.resource.data.description.size() > 10 &&
                      'targetUsername' in request.resource.data &&
                      'status' in request.resource.data &&
                      request.resource.data.status == 'pending';

      // ✅ CORREGIDO 2025-12-11: Solo admins pueden actualizar estado de reportes
      allow update: if isAdmin();

      // No se pueden eliminar reportes
      allow delete: if false;
    }

    // ===========================
    // REGLAS DE ANALYTICS (Estadísticas)
    // ===========================

    match /analytics_stats/{dateId} {
      // Cualquier usuario autenticado puede escribir (para tracking)
      allow write: if isAuthenticated();
      
      // Solo admins pueden leer estadísticas
      allow read: if isAdmin();
    }

    // ===========================
    // REGLAS DE CONEXIONES DE USUARIO (Verificación)
    // ===========================

    match /user_connections/{userId} {
      // Solo el propio usuario puede leer sus datos de conexión
      allow read: if isAuthenticated() && request.auth.uid == userId;
      
      // Solo el sistema puede escribir (mediante recordUserConnection)
      allow write: if isAuthenticated() && request.auth.uid == userId;
    }

    // ===========================
    // REGLAS DE TICKETS DE SOPORTE
    // ===========================

    match /tickets/{ticketId} {
      // Usuarios pueden leer sus propios tickets, admins pueden leer todos
      // IMPORTANTE: Para queries sin filtro, los admins necesitan poder leer todos
      allow read: if isAdmin() ||
                    (isAuthenticated() && 
                     (resource == null || resource.data.userId == request.auth.uid));

      // Usuarios autenticados pueden crear tickets
      allow create: if isAuthenticated() &&
                      'userId' in request.resource.data &&
                      request.resource.data.userId == request.auth.uid &&
                      'subject' in request.resource.data &&
                      'description' in request.resource.data &&
                      'category' in request.resource.data &&
                      'priority' in request.resource.data &&
                      'status' in request.resource.data &&
                      request.resource.data.status == 'open';

      // Solo admins pueden actualizar tickets (cambiar estado, agregar notas)
      allow update: if isAdmin();

      // No se pueden eliminar tickets
      allow delete: if false;
    }

    // ===========================
    // REGLAS POR DEFECTO
    // ===========================

    // Denegar acceso a cualquier otra colección no especificada
    match /{document=**} {
      allow read, write: if false;
    }
  }
}